<!DOCTYPE html>
<html lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… - ØªÙˆÙ‚Ø¹Ø§Øª Ø§Ù„Ù†Ø­Ø§Ø³</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="/static/css/style.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    {% include 'navbar.html' %}
    <div class="main-container">
        <!-- Page Header -->
        <div class="page-header fade-in">
            <h1>ğŸ“ˆ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… - ØªÙˆÙ‚Ø¹Ø§Øª Ø§Ù„Ù†Ø­Ø§Ø³</h1>
            <p class="page-subtitle">Ù…Ø±Ø§Ù‚Ø¨Ø© Ø£Ø³Ø¹Ø§Ø± Ø§Ù„Ù†Ø­Ø§Ø³ ÙˆÙ…Ø¤Ø´Ø±Ø§Øª Ø§Ù„Ø³ÙˆÙ‚ Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠØ©</p>
        </div>

        <!-- Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ù…ØªÙˆÙ‚Ø¹ -->
        <div class="card mb-4 fade-in">
            <div class="card-header">
                <h5 class="mb-0">ğŸ”® Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ù…ØªÙˆÙ‚Ø¹ Ù„Ù„Ù†Ø­Ø§Ø³</h5>
            </div>
            <div class="card-body text-center">
                <p class="result-value" id="tomorrowPrediction">--</p>
                <small class="text-muted">Ù…ØªÙˆØ³Ø· Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ù…ØªÙˆÙ‚Ø¹ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø¢Ø®Ø± Ø¨ÙŠØ§Ù†Ø§Øª Ù…ØªØ§Ø­Ø©</small>
            </div>
        </div>

        <!-- Ø§Ù„Ø±Ø³Ù… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠ Ø§Ù„ØªØ§Ø±ÙŠØ®ÙŠ -->
        <div class="card mb-4 fade-in">
            <div class="card-header">
                <h5 class="mb-0">ğŸ“‰ ØªØ§Ø±ÙŠØ® Ø£Ø³Ø¹Ø§Ø± Ø§Ù„Ù†Ø­Ø§Ø³ (Ø¢Ø®Ø± 60 ÙŠÙˆÙ…)</h5>
            </div>
            <div class="card-body">
                <div class="chart-wrapper">
                    <canvas id="copperHistoryChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Ù…Ø¤Ø´Ø±Ø§Øª Ø§Ù„Ø³ÙˆÙ‚ -->
        <div class="grid-3-cols fade-in">
            <div class="stat-card primary">
                <div class="stat-label">ğŸ›¢ï¸ Ø³Ø¹Ø± Ø§Ù„Ù†ÙØ· Brent</div>
                <div class="stat-value" id="oilPrice">--</div>
                <small class="text-muted">Ø¨Ø±Ù…ÙŠÙ„ ÙˆØ§Ø­Ø¯ (USD)</small>
            </div>
            <div class="stat-card success">
                <div class="stat-label">ğŸ’µ Ù…Ø¤Ø´Ø± Ø§Ù„Ø¯ÙˆÙ„Ø§Ø± DXY</div>
                <div class="stat-value" id="usdIndex">--</div>
                <small class="text-muted">Ù…Ø¤Ø´Ø± Ù‚ÙˆØ© Ø§Ù„Ø¯ÙˆÙ„Ø§Ø±</small>
            </div>
            <div class="stat-card warning">
                <div class="stat-label">ğŸ“Š Ù…Ø¹Ù†ÙˆÙŠØ§Øª Ø§Ù„Ø³ÙˆÙ‚</div>
                <div class="stat-value" id="marketSentiment">--</div>
                <small class="text-muted">Ù…Ø¤Ø´Ø± Ø§Ù„Ù…Ø´Ø§Ø¹Ø± (%)</small>
            </div>
        </div>

        <!-- Ø²Ø± Ø§Ù„ØªØ­Ø¯ÙŠØ« -->
        <div class="text-center mt-4 fade-in">
            <button class="refresh-btn" onclick="loadDashboardData()">
                ğŸ”„ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
            </button>
        </div>
    </div>

    <script>
        async function loadDashboardData() {
            try {
                const response = await fetch('/dashboard-data');
                const data = await response.json();
                // Ø¥Ø²Ø§Ù„Ø© Ø±Ø³Ø§Ù„Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø¥Ù† ÙˆØ¬Ø¯Øª
                const loadingEl = document.getElementById('dashboard-loading');
                if (loadingEl) loadingEl.remove();

                // Ø¹Ø±Ø¶ Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ù…ØªÙˆÙ‚Ø¹
                const tp = document.getElementById('tomorrowPrediction');
                if (tp && typeof data.predicted_price === 'number') {
                    tp.textContent = `$${data.predicted_price.toFixed(2)}`;
                }

                // Ø¹Ø±Ø¶ Ù…Ø¤Ø´Ø±Ø§Øª Ø§Ù„Ø³ÙˆÙ‚
                const oilEl = document.getElementById('oilPrice');
                const usdEl = document.getElementById('usdIndex');
                const sentEl = document.getElementById('marketSentiment');
                if (oilEl && typeof data.oil_price === 'number') oilEl.textContent = `$${data.oil_price.toFixed(2)}`;
                if (usdEl && typeof data.usd_index === 'number') usdEl.textContent = data.usd_index.toFixed(2);
                if (sentEl && typeof data.market_sentiment === 'number') sentEl.textContent = (data.market_sentiment * 100).toFixed(1) + '%';

                // Ø±Ø³Ù… Ø§Ù„Ø±Ø³Ù… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠ
                drawChart(data);
            } catch (error) {
                console.error('Error loading dashboard data:', error);
                // Ø¹Ø±Ø¶ Ø®Ø·Ø£ Ø¶Ù…Ù† Ø§Ù„ØµÙØ­Ø© Ø¨Ø¯Ù„ alert
                const loadingEl = document.getElementById('dashboard-loading');
                if (loadingEl) loadingEl.remove();
                const container = document.querySelector('.main-container');
                if (container) {
                    const errorHtml = `<div id="dashboard-error" class="alert alert-danger">Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: ${error.message}</div>`;
                    container.insertAdjacentHTML('afterbegin', errorHtml);
                }
            }
        }

        function drawChart(data) {
            const ctx = document.getElementById('copperHistoryChart').getContext('2d');
            
            // ØªØ¯Ù…ÙŠØ± Ø§Ù„Ø±Ø³Ù… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠ Ø§Ù„Ù‚Ø¯ÙŠÙ… Ø¥Ù† ÙˆØ¬Ø¯
            if (window.copperChart) {
                window.copperChart.destroy();
            }

            window.copperChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.history_dates,
                    datasets: [{
                        label: 'Ø³Ø¹Ø± Ø§Ù„Ù†Ø­Ø§Ø³ (USD)',
                        data: data.history_prices,
                        borderColor: '#b8860b',
                        backgroundColor: 'rgba(184, 134, 11, 0.1)',
                        fill: true,
                        tension: 0.4,
                        pointRadius: 3,
                        pointBackgroundColor: '#b8860b',
                        pointBorderColor: '#fff',
                        pointBorderWidth: 2,
                        pointHoverRadius: 5
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                            labels: {
                                font: { size: 12, weight: 'bold' },
                                padding: 20
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            ticks: {
                                callback: function(value) {
                                    return '$' + value.toFixed(2);
                                }
                            }
                        }
                    }
                }
            });
        }

        // Loading UI elements
        const dashboardLoadingHtml = `
            <div id="dashboard-loading" class="loading" style="text-align:center;padding:30px;">
                <div class="spinner-border" role="status"><span class="visually-hidden">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</span></div>
                <div class="loading-text mt-2">Ø¬Ø§Ø±ÙŠ Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù„ÙˆØ­Ø©...</div>
            </div>`;

        const dashboardErrorHtml = (msg) => `
            <div class="alert alert-danger" role="alert">Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: ${msg}</div>`;

        // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¹Ù†Ø¯ ÙØªØ­ Ø§Ù„ØµÙØ­Ø©
        window.addEventListener('load', () => {
            // Ø¥Ø¸Ù‡Ø§Ø± Ø­Ø§Ù„Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø¯Ø§Ø®Ù„ Ø§Ù„Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
            const container = document.querySelector('.main-container');
            if (container) {
                // Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù‡Ù†Ø§Ùƒ Ø¹Ù†ØµØ± ØªØ­Ù…ÙŠÙ„ØŒ Ø£Ø¶ÙÙ‡ Ø£Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø­ØªÙˆÙ‰
                if (!document.getElementById('dashboard-loading')) {
                    container.insertAdjacentHTML('afterbegin', dashboardLoadingHtml);
                }
            }
            loadDashboardData();
        });
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
