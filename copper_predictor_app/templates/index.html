<!DOCTYPE html>
<html lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>لوحة التحكم - توقعات النحاس</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <link rel="stylesheet" href="/static/css/style.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    {% include 'navbar.html' %}
    <div class="main-container">
        <!-- Page Header -->
        <div class="page-header fade-in">
            <h1><i class="bi bi-speedometer2" style="color: #667eea; margin-left: 10px;"></i> لوحة التحكم - توقعات النحاس</h1>
            <p class="page-subtitle">مراقبة أسعار النحاس ومؤشرات السوق الحقيقية</p>
        </div>

        <!-- السعر المتوقع -->
        <div class="card mb-4 fade-in">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-graph-up-arrow" style="color: #667eea; margin-left: 5px;"></i> السعر المتوقع للنحاس</h5>
            </div>
            <div class="card-body text-center">
                <p class="result-value" id="tomorrowPrediction">--</p>
                <small class="text-muted">متوسط السعر المتوقع بناءً على آخر بيانات متاحة</small>
            </div>
        </div>

        <!-- الرسم البياني التاريخي -->
        <div class="card mb-4 fade-in">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-graph-down" style="color: #667eea; margin-left: 5px;"></i> تاريخ أسعار النحاس (آخر 60 يوم)</h5>
            </div>
            <div class="card-body">
                <div class="chart-wrapper">
                    <canvas id="copperHistoryChart"></canvas>
                </div>
            </div>
        </div>

        <!-- مؤشرات السوق -->
        <div class="grid-3-cols fade-in">
            <div class="stat-card primary">
                <div class="stat-label"><i class="bi bi-droplet-fill" style="color: #667eea; margin-left: 5px;"></i> سعر النفط Brent</div>
                <div class="stat-value" id="oilPrice">--</div>
                <small class="text-muted">برميل واحد (USD)</small>
            </div>
            <div class="stat-card success">
                <div class="stat-label"><i class="bi bi-currency-dollar" style="color: #667eea; margin-left: 5px;"></i> مؤشر الدولار DXY</div>
                <div class="stat-value" id="usdIndex">--</div>
                <small class="text-muted">مؤشر قوة الدولار</small>
            </div>
            <div class="stat-card warning">
                <div class="stat-label"><i class="bi bi-bar-chart-line" style="color: #667eea; margin-left: 5px;"></i> معنويات السوق</div>
                <div class="stat-value" id="marketSentiment">--</div>
                <small class="text-muted">مؤشر المشاعر (%)</small>
            </div>
        </div>

        <!-- زر التحديث -->
        <div class="text-center mt-4 fade-in">
            <button class="refresh-btn" onclick="loadDashboardData()">
                <i class="bi bi-arrow-clockwise" style="margin-left: 5px;"></i> تحديث البيانات
            </button>
        </div>
    </div>

    <script>
        async function loadDashboardData() {
            try {
                const response = await fetch('/dashboard-data');
                const data = await response.json();
                // إزالة رسالة التحميل إن وجدت
                const loadingEl = document.getElementById('dashboard-loading');
                if (loadingEl) loadingEl.remove();

                // عرض السعر المتوقع
                const tp = document.getElementById('tomorrowPrediction');
                if (tp && typeof data.predicted_price === 'number') {
                    tp.textContent = `$${data.predicted_price.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
                }

                // عرض مؤشرات السوق
                const oilEl = document.getElementById('oilPrice');
                const usdEl = document.getElementById('usdIndex');
                const sentEl = document.getElementById('marketSentiment');
                if (oilEl && typeof data.oil_price === 'number') oilEl.textContent = `$${data.oil_price.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
                if (usdEl && typeof data.usd_index === 'number') usdEl.textContent = data.usd_index.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
                if (sentEl && typeof data.market_sentiment === 'number') sentEl.textContent = (data.market_sentiment * 100).toLocaleString('en-US', {minimumFractionDigits: 1, maximumFractionDigits: 1}) + '%';

                // رسم الرسم البياني
                drawChart(data);
            } catch (error) {
                console.error('Error loading dashboard data:', error);
                // عرض خطأ ضمن الصفحة بدل alert
                const loadingEl = document.getElementById('dashboard-loading');
                if (loadingEl) loadingEl.remove();
                const container = document.querySelector('.main-container');
                if (container) {
                    const errorHtml = `<div id="dashboard-error" class="alert alert-danger">خطأ في تحميل البيانات: ${error.message}</div>`;
                    container.insertAdjacentHTML('afterbegin', errorHtml);
                }
            }
        }

        function drawChart(data) {
            const ctx = document.getElementById('copperHistoryChart').getContext('2d');
            
            // تدمير الرسم البياني القديم إن وجد
            if (window.copperChart) {
                window.copperChart.destroy();
            }

            window.copperChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.history_dates,
                    datasets: [{
                        label: 'سعر النحاس (USD)',
                        data: data.history_prices,
                        borderColor: '#b8860b',
                        backgroundColor: 'rgba(184, 134, 11, 0.1)',
                        fill: true,
                        tension: 0.4,
                        pointRadius: 3,
                        pointBackgroundColor: '#b8860b',
                        pointBorderColor: '#fff',
                        pointBorderWidth: 2,
                        pointHoverRadius: 5
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                            labels: {
                                font: { size: 12, weight: 'bold' },
                                padding: 20
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            ticks: {
                                callback: function(value) {
                                    return '$' + value.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
                                }
                            }
                        }
                    }
                }
            });
        }

        // Loading UI elements
        const dashboardLoadingHtml = `
            <div id="dashboard-loading" class="loading" style="text-align:center;padding:30px;">
                <div class="spinner-border" role="status"><span class="visually-hidden">جاري التحميل...</span></div>
                <div class="loading-text mt-2">جاري جلب بيانات اللوحة...</div>
            </div>`;

        const dashboardErrorHtml = (msg) => `
            <div class="alert alert-danger" role="alert">خطأ في تحميل البيانات: ${msg}</div>`;

        // تحميل البيانات عند فتح الصفحة
        window.addEventListener('load', () => {
            // إظهار حالة التحميل داخل المنطقة الرئيسية
            const container = document.querySelector('.main-container');
            if (container) {
                // إذا لم يكن هناك عنصر تحميل، أضفه أعلى المحتوى
                if (!document.getElementById('dashboard-loading')) {
                    container.insertAdjacentHTML('afterbegin', dashboardLoadingHtml);
                }
            }
            loadDashboardData();
        });
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
